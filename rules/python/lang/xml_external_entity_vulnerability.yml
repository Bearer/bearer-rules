imports:
  - python_shared_common_external_input
  - python_shared_lang_instance
  - python_shared_lang_import2
  - python_shared_lang_import3
patterns:
  - pattern: |
      $<XML_SAX>($<EXTERNAL_INPUT>$<...>)
    filters:
      - variable: XML_SAX
        detection: python_shared_lang_import2
        scope: cursor
        filters:
          - variable: MODULE1
            values: [xml]
          - variable: MODULE2
            values: [sax]
          - variable: NAME
            values:
              - parse
              - parseString
      - variable: EXTERNAL_INPUT
        detection: python_shared_common_external_input
        scope: result
  - pattern: |
      $<PULLDOM>($<EXTERNAL_INPUT>$<...>)
    filters:
      - variable: PULLDOM
        detection: python_shared_lang_import3
        scope: cursor
        filters:
          - variable: MODULE1
            values: [xml]
          - variable: MODULE2
            values: [dom]
          - variable: MODULE3
            values: [pulldom]
          - variable: NAME
            values:
              - parse
              - parseString
      - variable: EXTERNAL_INPUT
        detection: python_shared_common_external_input
        scope: result
languages:
  - python
severity: medium
metadata:
  description: Usage of vulnerable XML libraries
  remediation_message: |-
    ## Description

    Certain XML parsers - like xml.sax and pulldom - are known to be vulnerable to XML parsing attacks such as Billion Laughs (exponential entity expansion). These parsers should be avoided. Avoid such vulnerable libraries, and as an additional precaution, use something like defusedxml to further mitigate XML vulnerabilities in Python.   

    ## Remediations

    - **Do not** use XML parsers that are known to be vulnerable to external entity attacks.
    - **Do** exercise caution when parsing XML and always ensure parser input is sufficiently validated and sanitized.

    ## References

    - [Python XML parsers and their vulnerabilities](https://docs.python.org/3/library/xml.html#xml-vulnerabilities)
    - [The defusexml package](https://pypi.org/project/defusedxml/)
    - [OWASP XML External Entity (XXE) prevention cheat sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#python)
  cwe_id:
    - 611
  id: python_lang_xml_external_entity_vulnerability
  documentation_url: https://docs.bearer.com/reference/rules/python_lang_xml_external_entity_vulnerability
