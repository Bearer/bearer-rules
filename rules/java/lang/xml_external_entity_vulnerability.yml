imports:
  - java_shared_lang_user_input
patterns:
  - pattern: $<DOCUMENT_BUILDER>.parse($<XML_INPUT>$<...>)
    filters:
      - variable: DOCUMENT_BUILDER
        detection: java_lang_xml_external_entity_vulnerability_document_builder
      - either:
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_input_stream
            scope: cursor
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_file
            scope: cursor
  - pattern: $<UNMARSHALLER>.unmarshal($<XML_INPUT>$<...>)
    filters:
      - variable: UNMARSHALLER
        detection: java_lang_xml_external_entity_vulnerability_unmarshaller
      - either:
          - variable: XML_INPUT
            detection: java_shared_lang_user_input
            scope: cursor
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_input_stream
            scope: cursor
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_file
            scope: cursor
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_url
            scope: cursor
          - variable: XML_INPUT
            detection: java_lang_xml_external_entity_vulnerability_stream_source
            scope: cursor
auxiliary:
  - id: java_lang_xml_external_entity_vulnerability_input_stream
    patterns:
      - pattern: $<_> $<INPUT_STREAM> = new $<INPUT_STREAM_CLASS>($<USER_INPUT>$<...>);
        focus: INPUT_STREAM
        filters:
          - variable: INPUT_STREAM_CLASS
            regex: \A(java\.io\.)?(InputStream|ByteArrayInputStream|FileInputStream|StringBufferInputStream)\z
          - variable: USER_INPUT
            detection: java_shared_lang_user_input
            scope: cursor
  - id: java_lang_xml_external_entity_vulnerability_file
    patterns:
      - pattern: $<FILE_CLASS> $<FILE> = new $<FILE_CLASS>($<USER_INPUT>$<...>);
        focus: FILE
        filters:
          - variable: FILE_CLASS
            regex: \A(java\.io\.)?File\z
          - variable: USER_INPUT
            detection: java_shared_lang_user_input
            scope: cursor
  - id: java_lang_xml_external_entity_vulnerability_url
    patterns:
      - pattern: $<URL_CLASS> $<URL> = new $<URL_CLASS>($<USER_INPUT>$<...>);
        focus: URL
        filters:
          - variable: URL_CLASS
            regex: \A(java\.net\.)?URL\z
          - variable: USER_INPUT
            detection: java_shared_lang_user_input
            scope: cursor
  - id: java_lang_xml_external_entity_vulnerability_stream_source
    patterns:
      - pattern: new StreamSource($<STRING_READER>);
        filters:
          - variable: STRING_READER
            detection: java_lang_xml_external_entity_vulnerability_string_reader
  - id: java_lang_xml_external_entity_vulnerability_string_reader
    patterns:
      - pattern: new $<STRING_READER_CLASS>($<STRING_BUFFER>.toString());
        filters:
          - variable: STRING_READER_CLASS
            regex: \A(java\.lang\.)?StringReader\z
          - variable: STRING_BUFFER
            detection: java_lang_xml_external_entity_vulnerability_string_buffer
  - id: java_lang_xml_external_entity_vulnerability_string_buffer
    patterns:
      - pattern: $<STRING_BUFFER_CLASS> $<STRING_BUFFER> = new $<STRING_BUFFER_CLASS>($<USER_INPUT>$<...>);
        focus: STRING_BUFFER
        filters:
          - variable: STRING_BUFFER_CLASS
            regex: \A(java\.lang\.)?StringBuffer\z
          - variable: USER_INPUT
            detection: java_shared_lang_user_input
            scope: cursor
  - id: java_lang_xml_external_entity_vulnerability_document_builder
    patterns:
      - pattern: $<DOCUMENT_BUILDER>.newDocumentBuilder();
        filters:
          - variable: DOCUMENT_BUILDER
            detection: java_lang_xml_external_entity_vulnerability_document_builder_factory
  - id: java_lang_xml_external_entity_vulnerability_document_builder_factory
    patterns:
      - pattern: $<DOCUMENT_BUILDER_FACTORY>.newInstance();
        filters:
          - variable: DOCUMENT_BUILDER_FACTORY
            regex: \A(javax\.xml\.parsers\.)?DocumentBuilderFactory\z
  - id: java_lang_xml_external_entity_vulnerability_unmarshaller
    patterns:
      - pattern: $<JAXB_INSTANCE>.createUnmarshaller();
        filters:
          - variable: JAXB_INSTANCE
            detection: java_lang_xml_external_entity_vulnerability_jaxb_instance
  - id: java_lang_xml_external_entity_vulnerability_jaxb_instance
    patterns:
      - pattern: $<JAXB>.newInstance();
        filters:
          - variable: JAXB
            regex: \A(javax\.xml\.bind\.)?JAXBContext\z
languages:
  - java
severity: critical
metadata:
  description: Unsanitized user input in XML External Entity
  remediation_message: |
    ## Description
    Avoid parsing untrusted data as XML. Such data could include URIs that resolve to resources that are outside of the current context, leading to XML External Entity (XXE) injection.

    ## Remediations

    ‚ùå Do not enable parsing of external entities.

    ## Resources
    - [OWASP XML External Entity (XXE) prevention cheat sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
  cwe_id:
    - 611
  id: java_lang_xml_external_entity_vulnerability
  documentation_url: https://docs.bearer.com/reference/rules/java_lang_xml_external_entity_vulnerability
